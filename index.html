<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#F5F1E9">
  <title>Schedule</title>
  
  <link rel="apple-touch-icon" href="icon3.png">
  <link rel="icon" type="image/png" href="icon3.png">

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Zen+Maru+Gothic:wght@300;400;500;700&display=swap');
    body { font-family: 'Zen Maru Gothic', sans-serif; -webkit-tap-highlight-color: transparent; }
    .font-hand { font-family: 'Caveat', cursive; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>

  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
      "lucide-react": "https://esm.sh/lucide-react@0.309.0",
      "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
      "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
      "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
    }
  }
  </script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-[#F5F1E9] text-[#5D4037] overflow-hidden">
  
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      ChevronLeft, ChevronRight, X, Sparkles, Clock, Trash2, 
      Loader2, Save, AlignLeft, Leaf, CheckSquare, Plus, Edit, Coffee, Settings, Copy, User, Users
    } from 'lucide-react';
    import { initializeApp } from 'firebase/app';
    import { 
      getAuth, onAuthStateChanged, signInAnonymously 
    } from 'firebase/auth';
    import { 
      getFirestore, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, doc, setDoc, getDoc
    } from 'firebase/firestore';
    import { CalendarHeart } from 'lucide-react';
    const firebaseConfig = {
      apiKey: "AIzaSyAaeMl8u3S8Atf5b9Z4MvYRfxNWqyxjvck",
      authDomain: "schdule-f5cda.firebaseapp.com",
      projectId: "schdule-f5cda",
      storageBucket: "schdule-f5cda.firebasestorage.app",
      messagingSenderId: "318490887020",
      appId: "1:318490887020:web:115d4b35f544455768e949",
      measurementId: "G-Q7ZEKV7YEH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = 'schdule-f5cda';

    const COLORS = {
      milk: { name: '燕麥奶', bg: 'bg-[#FDFBF7]', text: 'text-[#8C7851]', border: 'border-[#E8E2D6]', fill: 'bg-[#E8E2D6]' },
      tea: { name: '伯爵茶', bg: 'bg-[#F5F1E9]', text: 'text-[#5D4037]', border: 'border-[#D2B48C]', fill: 'bg-[#D2B48C]' }, 
      latte: { name: '深焙', bg: 'bg-[#C2A385]', text: 'text-white', border: 'border-[#8B4513]', fill: 'bg-[#C2A385]' }, 
      matcha: { name: '抹茶', bg: 'bg-[#F0FDF4]', text: 'text-[#166534]', border: 'border-[#BBF7D0]', fill: 'bg-[#86EFAC]' }, 
      berry: { name: '莓果', bg: 'bg-[#FFF1F2]', text: 'text-[#9F1239]', border: 'border-[#FECDD3]', fill: 'bg-[#FDA4AF]' },
      taro: { name: '芋泥', bg: 'bg-[#FAF5FF]', text: 'text-[#6B21A8]', border: 'border-[#E9D5FF]', fill: 'bg-[#D8B4FE]' },
      lemon: { name: '檸檬塔', bg: 'bg-[#FEFCE8]', text: 'text-[#854D0E]', border: 'border-[#FEF08A]', fill: 'bg-[#FDE047]' },
      sesame: { name: '芝麻', bg: 'bg-[#F8FAFC]', text: 'text-[#334155]', border: 'border-[#CBD5E1]', fill: 'bg-[#94A3B8]' },
      earl: { name: '伯爵藍', bg: 'bg-[#F0F9FF]', text: 'text-[#0C4A6E]', border: 'border-[#BAE6FD]', fill: 'bg-[#7DD3FC]' },
    };

    const FALLBACK_HOLIDAYS = {
      // 2025
      "2025-01-01": { isHoliday: true, name: "元旦" },
      "2025-01-25": { isHoliday: true, name: "除夕" },
      "2025-01-26": { isHoliday: true, name: "春節" },
      "2025-02-28": { isHoliday: true, name: "和平紀念日" },
      "2025-04-04": { isHoliday: true, name: "兒童節" },
      "2025-04-05": { isHoliday: true, name: "清明節" },
      "2025-05-01": { isHoliday: true, name: "勞動節" },
      "2025-05-31": { isHoliday: true, name: "端午節" },
      "2025-10-06": { isHoliday: true, name: "中秋節" },
      "2025-10-10": { isHoliday: true, name: "國慶日" },
      // 2026
      "2026-01-01": { isHoliday: true, name: "元旦" },
      "2026-02-16": { isHoliday: true, name: "除夕" },
      "2026-02-17": { isHoliday: true, name: "春節" },
      "2026-04-04": { isHoliday: true, name: "兒童節" },
      "2026-04-05": { isHoliday: true, name: "清明節" },
      "2026-06-19": { isHoliday: true, name: "端午節" },
      "2026-09-25": { isHoliday: true, name: "中秋節" },
      "2026-10-10": { isHoliday: true, name: "國慶日" }
    };

    // --- Helper Functions ---
    const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
    const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
    const formatDate = (date) => {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    };

    const App = () => {
      const [user, setUser] = useState(null);
      const [customUserId, setCustomUserId] = useState(localStorage.getItem('bibi_custom_uid') || '');
      
      const [currentDate, setCurrentDate] = useState(new Date());
      const [events, setEvents] = useState([]);
      // [NEW] Role Settings: Default to '我' and '夥伴' but sync from DB
      const [roleSettings, setRoleSettings] = useState({ role1: '我', role2: '夥伴' });
      
      const [loading, setLoading] = useState(true);
      const [holidayData, setHolidayData] = useState(() => {
        const initialData = {};
        Object.entries(FALLBACK_HOLIDAYS).forEach(([date, info]) => {
            const y = parseInt(date.split('-')[0]);
            if (!initialData[y]) initialData[y] = {};
            initialData[y][date] = info;
        });
        return initialData;
      });

      const [isEditModalOpen, setIsEditModalOpen] = useState(false);
      const [isDayViewModalOpen, setIsDayViewModalOpen] = useState(false); 
      const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false); 
      const [viewingDate, setViewingDate] = useState(null);
      
      const [editingId, setEditingId] = useState(null);

      // Form State
      const [formTitle, setFormTitle] = useState('');
      const [formDesc, setFormDesc] = useState('');
      const [formStartDate, setFormStartDate] = useState('');
      const [formEndDate, setFormEndDate] = useState('');
      const [formIsAllDay, setFormIsAllDay] = useState(true);
      const [formStartTime, setFormStartTime] = useState('09:00');
      const [formEndTime, setFormEndTime] = useState('10:00');
      const [formColor, setFormColor] = useState('latte');
      const [formEventType, setFormEventType] = useState('common');

      // Settings Form State
      const [tempRole1, setTempRole1] = useState('');
      const [tempRole2, setTempRole2] = useState('');

      // --- Auth ---
      useEffect(() => {
        signInAnonymously(auth).catch((error) => console.error("Auth Failed:", error));
        return onAuthStateChanged(auth, setUser);
      }, []);

      // --- Holiday API ---
      useEffect(() => {
        const currentYear = currentDate.getFullYear();
        const fetchHolidays = async () => {
          try {
            const response = await fetch(`https://cdn.jsdelivr.net/gh/ruyut/TaiwanCalendar/data/${currentYear}.json`);
            if (!response.ok) return;
            const rawData = await response.json();
            const formatted = rawData.reduce((acc, curr) => {
              const dStr = curr.date;
              if (dStr && dStr.length === 8) {
                 const ymd = `${dStr.substring(0, 4)}-${dStr.substring(4, 6)}-${dStr.substring(6, 8)}`;
                 acc[ymd] = { isHoliday: curr.isHoliday, name: curr.description };
              }
              return acc;
            }, {});
            setHolidayData(prev => ({ ...prev, [currentYear]: { ...(prev[currentYear] || {}), ...formatted } }));
          } catch (err) { console.error(err); }
        };
        fetchHolidays();
      }, [currentDate.getFullYear()]);

      // --- Firestore (Data & Settings) ---
      useEffect(() => {
        const targetUid = customUserId || user?.uid;
        if (!targetUid) return;
        
        // 1. Listen to Events
        const qEvents = query(collection(db, 'artifacts', appId, 'users', targetUid, 'bibi_events'));
        const unsubEvents = onSnapshot(qEvents, (snapshot) => {
          const loadedEvents = [];
          snapshot.forEach((doc) => loadedEvents.push({ id: doc.id, ...doc.data() }));
          setEvents(loadedEvents);
          setLoading(false);
        }, (err) => console.error("Firestore Events Error:", err));

        // 2. Listen to Role Settings (Sync Names)
        const settingsDocRef = doc(db, 'artifacts', appId, 'users', targetUid, 'bibi_settings', 'roles');
        const unsubSettings = onSnapshot(settingsDocRef, (docSnap) => {
          if (docSnap.exists()) {
            setRoleSettings(docSnap.data());
          } else {
            // If no settings exist yet, keep defaults or save defaults?
            // Keeping defaults in local state is fine.
          }
        });

        return () => { unsubEvents(); unsubSettings(); };
      }, [user, customUserId]);

      // --- Handlers ---
      const handleSaveCustomUid = () => {
        localStorage.setItem('bibi_custom_uid', customUserId);
        window.location.reload(); 
      };

      const handleResetUid = () => {
        localStorage.removeItem('bibi_custom_uid');
        window.location.reload();
      };

      const handleCopyId = () => {
        const text = user?.uid;
        if (!text) return;
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try { document.execCommand('copy'); } catch (err) { console.error('Copy failed', err); }
        document.body.removeChild(textArea);
      };

      // [NEW] Save Role Names
      const handleSaveRoles = async () => {
        const targetUid = customUserId || user?.uid;
        if (!targetUid) return;
        
        const newRoles = {
          role1: tempRole1 || roleSettings.role1,
          role2: tempRole2 || roleSettings.role2
        };

        try {
          await setDoc(doc(db, 'artifacts', appId, 'users', targetUid, 'bibi_settings', 'roles'), newRoles);
          setRoleSettings(newRoles);
          setIsSettingsModalOpen(false);
        } catch (e) { console.error("Save Roles Error:", e); }
      };

      const openSettings = () => {
        setTempRole1(roleSettings.role1);
        setTempRole2(roleSettings.role2);
        setIsSettingsModalOpen(true);
      };

      // --- Calendar Logic ---
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const daysInMonth = getDaysInMonth(year, month);
      const firstDay = getFirstDayOfMonth(year, month);
      
      const days = [];
      for (let i = firstDay - 1; i >= 0; i--) days.push({ day: null, fullDate: '' });
      for (let i = 1; i <= daysInMonth; i++) {
        const dStr = String(i).padStart(2, '0');
        const mStr = String(month + 1).padStart(2, '0');
        days.push({ day: i, fullDate: `${year}-${mStr}-${dStr}` });
      }
      const remainingCells = 42 - days.length;
      for (let i = 1; i <= remainingCells; i++) days.push({ day: null, fullDate: '' });

      const handlePrevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
      const handleNextMonth = () => setCurrentDate(new Date(year, month + 1, 1));
      const handleToday = () => setCurrentDate(new Date());

      const getEventSegments = (dateStr) => {
        if (!dateStr) return [];
        const dayEvents = events.filter(ev => dateStr >= ev.startDate && dateStr <= ev.endDate);
        dayEvents.sort((a, b) => {
          const lenA = new Date(a.endDate).getTime() - new Date(a.startDate).getTime();
          const lenB = new Date(b.endDate).getTime() - new Date(b.startDate).getTime();
          if (lenA !== lenB) return lenB - lenA; 
          const timeA = a.startTime || '00:00';
          const timeB = b.startTime || '00:00';
          if (timeA !== timeB) return timeA.localeCompare(timeB);
          return a.id.localeCompare(b.id);
        });
        return dayEvents.map(ev => {
          const isStart = dateStr === ev.startDate;
          const isEnd = dateStr === ev.endDate;
          const dayOfWeek = new Date(dateStr).getDay();
          return { ...ev, isStart, isEnd, isSunday: dayOfWeek === 0, isSaturday: dayOfWeek === 6 };
        });
      };

      const handleDayClick = (dateStr) => {
        setViewingDate(dateStr);
        setIsDayViewModalOpen(true);
      };

      const openEditModal = (dateStr, event = null) => {
         setEditingId(event ? event.id : null);
         setFormTitle(event ? event.title : '');
         setFormDesc(event ? (event.description || '') : '');
         setFormStartDate(event ? event.startDate : dateStr);
         setFormEndDate(event ? event.endDate : dateStr);
         setFormIsAllDay(event ? event.isAllDay : true);
         setFormStartTime(event ? (event.startTime || '09:00') : '09:00');
         setFormEndTime(event ? (event.endTime || '10:00') : '10:00');
         setFormColor(event ? event.color : 'latte');
         setFormEventType(event ? event.eventType : 'common');
         setIsDayViewModalOpen(false); 
         setIsEditModalOpen(true);
      };

      const saveEvent = async () => {
        const targetUid = customUserId || user?.uid;
        if (!targetUid || !formTitle || !formStartDate || !formEndDate) return;
        let start = formStartDate;
        let end = formEndDate;
        if (new Date(start) > new Date(end)) [start, end] = [end, start];

        const eventData = {
          title: formTitle, description: formDesc,
          startDate: start, endDate: end,
          isAllDay: formIsAllDay, startTime: formStartTime, endTime: formEndTime,
          color: formColor, eventType: formEventType
        };

        try {
          if (editingId) {
            await updateDoc(doc(db, 'artifacts', appId, 'users', targetUid, 'bibi_events', editingId), eventData);
          } else {
            await addDoc(collection(db, 'artifacts', appId, 'users', targetUid, 'bibi_events'), eventData);
          }
          setIsEditModalOpen(false);
          if(viewingDate) setIsDayViewModalOpen(true);
        } catch (e) { console.error("Save Error:", e); }
      };

      const deleteEvent = async () => {
        const targetUid = customUserId || user?.uid;
        if (targetUid && editingId) {
          try {
            await deleteDoc(doc(db, 'artifacts', appId, 'users', targetUid, 'bibi_events', editingId));
            setIsEditModalOpen(false);
            if(viewingDate) setIsDayViewModalOpen(true);
          } catch (e) { console.error("Delete Error:", e); }
        }
      };

      if (loading) return <div className="h-dvh flex items-center justify-center"><Loader2 className="w-8 h-8 text-[#C2A385] animate-spin" /></div>;
      
      const dayViewEvents = viewingDate ? events.filter(ev => viewingDate >= ev.startDate && viewingDate <= ev.endDate).sort((a,b) => (a.startTime||'00:00').localeCompare(b.startTime||'00:00')) : [];

      return (
        <div className="h-dvh flex flex-col">
          {/* Header */}
          <header className="flex-none flex items-center justify-between px-4 pb-3 pt-[calc(env(safe-area-inset-top)+12px)] bg-[#F5F1E9] border-b border-[#D2B48C]/20 z-10">
            <div className="flex items-center gap-3">
                <div className="bg-white p-2 rounded-xl shadow-sm border border-[#E8E2D6]">
                  <CalendarHeart className="w-5 h-5 text-[#C2A385]" />
                </div>
               <div>
                 <h1 className="text-xl font-hand font-bold tracking-tight text-[#5D4037] text-2xl">BiBi♥❣</h1>
                 <p className="text-[12px] font-hand font-bold text-[#8C7851] uppercase tracking-widest hidden sm:block">{year} . {month + 1}</p>
               </div>
            </div>
            <div className="flex items-center gap-2">
              <div className="flex items-center gap-1 bg-white/50 p-1.5 rounded-2xl border border-[#D2B48C]/10 backdrop-blur-sm mr-2">
                <button onClick={handlePrevMonth} className="p-2 hover:bg-[#E8E2D6]/50 rounded-xl transition-colors text-[#8C7851]"><ChevronLeft className="w-5 h-5" /></button>
                <span className="text-xl font-hand font-bold min-w-[80px] text-center text-[#5D4037]">{month + 1}月 <span className="text-base font-hand text-[#8C7851]">{year}</span></span>
                <button onClick={handleNextMonth} className="p-2 hover:bg-[#E8E2D6]/50 rounded-xl transition-colors text-[#8C7851]"><ChevronRight className="w-5 h-5" /></button>
              </div>
              <button onClick={openSettings} className="bg-white text-[#8C7851] p-2.5 rounded-xl shadow-sm border border-[#E8E2D6] hover:bg-[#FDFBF7]"><Settings className="w-5 h-5" /></button>
            </div>
          </header>

          {/* Weekday */}
          <div className="flex-none grid grid-cols-7 border-b border-[#D2B48C]/20 bg-[#FDFBF7]">
            {['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'].map((d, i) => (
              <div key={i} className={`py-2 text-center text-[12px] font-hand font-bold tracking-widest ${(i === 0 || i === 6) ? 'text-[#9F1239]' : 'text-[#D2B48C]'}`}>{d}</div>
            ))}
          </div>

          {/* Grid */}
          <div className="flex-1 grid grid-cols-7 grid-rows-6 w-full h-full">
            {days.map((cell, idx) => {
              const hasDate = cell.day !== null;
              const segments = hasDate ? getEventSegments(cell.fullDate) : [];
              const isToday = hasDate && cell.fullDate === formatDate(new Date());
              const holidayInfo = hasDate ? holidayData[year]?.[cell.fullDate] : null;
              const isHoliday = holidayInfo?.isHoliday === true;
              const dayOfWeek = idx % 7;
              const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
              let bgClass = 'bg-[#FDFBF7]';
              if (!hasDate) bgClass = 'bg-[#F5F1E9]/50';
              else if (isHoliday || isWeekend) bgClass = 'bg-[#F2E8DA]';
              const dateTextColor = (isHoliday || dayOfWeek === 0) ? 'text-[#9F1239]' : 'text-[#5D4037]';

              return (
                <div key={idx} onClick={() => hasDate && handleDayClick(cell.fullDate)} className={`relative border-b border-r border-[#D2B48C]/10 flex flex-col ${bgClass} active:brightness-95 transition-colors cursor-pointer select-none`}>
                  {hasDate && (
                    <div className="flex flex-col items-center pt-1 mb-0.5 px-0 min-h-[38px] justify-start">
                       <span className={`text-lg sm:text-xl font-hand font-bold h-7 w-7 flex items-center justify-center rounded-full transition-all ${isToday ? 'bg-[#C2A385] text-white shadow-md' : dateTextColor}`}>{cell.day}</span>
                       {isHoliday && <span className="text-[10px] text-[#9F1239] font-medium -mt-1 truncate max-w-full px-1 leading-tight">{holidayInfo.name}</span>}
                    </div>
                  )}
                  <div className="flex-1 flex flex-col gap-[2px] w-full pb-1 px-0">
                    {segments.slice(0, 4).map((ev) => {
                      const roundLeft = ev.isStart || ev.isSunday;
                      const roundRight = ev.isEnd || ev.isSaturday;
                      const style = COLORS[ev.color] || COLORS.latte;
                      
                      let marginClass = '';
                      if (!roundLeft) marginClass += ' -ml-[1px] rounded-l-none';
                      else marginClass += ' ml-1 rounded-l-md';
                      
                      if (!roundRight) marginClass += ' -mr-[1px] rounded-r-none';
                      else marginClass += ' mr-1 rounded-r-md';

                      return (
                        <div key={ev.id} onClick={(e) => { e.stopPropagation(); openEditModal(null, ev); }} className={`text-[10px] sm:text-xs h-[18px] sm:h-[20px] flex items-center px-1 transition-all hover:brightness-95 relative z-10 ${style.fill} ${style.text === 'text-white' ? 'text-white' : 'text-[#5D4037]'} ${marginClass}`}>
                          {(ev.isStart || ev.isSunday) && <span className="truncate w-full font-medium leading-none flex items-center gap-1">{!ev.isAllDay && ev.startTime && <span className="text-[9px] opacity-80 font-hand">{ev.startTime}</span>}{ev.title}</span>}
                        </div>
                      );
                    })}
                    {segments.length > 4 && <div className="text-[10px] font-hand text-[#D2B48C] text-center leading-none mt-auto font-bold">+{segments.length - 4}</div>}
                  </div>
                </div>
              )
            })}
          </div>

          {/* Settings Modal (Sync ID + Profile Names) */}
          {isSettingsModalOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-[#5D4037]/20 backdrop-blur-[2px] p-4">
               <div className="bg-white w-full max-w-sm rounded-[1.5rem] shadow-2xl overflow-hidden animate-in fade-in zoom-in-95 duration-200 border border-[#D2B48C]/30 flex flex-col max-h-[90vh]">
                  <div className="p-6 space-y-5 overflow-y-auto">
                    <div className="flex justify-between items-center pb-2 border-b border-[#F5F1E9]">
                      <h3 className="font-bold text-[#5D4037] flex items-center gap-2"><Settings className="w-5 h-5"/> 設定 & 同步</h3>
                      <button onClick={() => setIsSettingsModalOpen(false)} className="p-1 text-[#8C7851] hover:bg-[#F5F1E9] rounded-full"><X className="w-5 h-5" /></button>
                    </div>
                    
                    {/* ID Sync Section */}
                    <div className="space-y-2">
                      <label className="text-xs font-bold text-[#8C7851] uppercase">裝置識別碼 (ID)</label>
                      <div className="flex gap-2 items-center bg-[#FDFBF7] border border-[#E8E2D6] p-2 rounded-lg">
                        <code className="text-[10px] text-[#5D4037] break-all flex-1">{user?.uid || 'Loading...'}</code>
                        <button onClick={handleCopyId} className="p-1 text-[#C2A385] hover:bg-white rounded"><Copy className="w-4 h-4" /></button>
                      </div>
                      <div className="pt-2">
                        <input 
                          type="text" 
                          value={customUserId} 
                          onChange={(e) => setCustomUserId(e.target.value)}
                          placeholder="手動輸入 ID 以同步資料..."
                          className="w-full text-sm border border-[#E8E2D6] rounded-lg p-2 text-[#5D4037] focus:border-[#C2A385] outline-none placeholder:text-[#D2B48C]"
                        />
                      </div>
                      <div className="flex gap-2 pt-1">
                        <button onClick={handleResetUid} className="flex-1 py-2 text-xs font-bold text-[#8C7851] bg-[#F5F1E9] rounded-lg">重置</button>
                        <button onClick={handleSaveCustomUid} className="flex-1 py-2 text-xs font-bold text-white bg-[#C2A385] rounded-lg shadow-sm">切換帳號</button>
                      </div>
                    </div>

                    <hr className="border-[#F5F1E9]" />

                    {/* Role Names Section */}
                    <div className="space-y-3">
                      <label className="text-xs font-bold text-[#8C7851] uppercase flex items-center gap-1"><Users className="w-3 h-3"/> 角色名稱設定</label>
                      <p className="text-[10px] text-[#8C7851] opacity-80">設定的名字將會同步到所有連結此 ID 的裝置。</p>
                      
                      <div className="grid grid-cols-2 gap-3">
                        <div className="space-y-1">
                           <span className="text-[10px] font-bold text-[#5D4037]">角色 A </span>
                           <input 
                             type="text" 
                             value={tempRole1} 
                             onChange={(e) => setTempRole1(e.target.value)}
                             className="w-full text-sm border border-[#E8E2D6] rounded-lg p-2 text-[#5D4037] focus:border-[#C2A385] outline-none text-center"
                           />
                        </div>
                        <div className="space-y-1">
                           <span className="text-[10px] font-bold text-[#5D4037]">角色 B </span>
                           <input 
                             type="text" 
                             value={tempRole2} 
                             onChange={(e) => setTempRole2(e.target.value)}
                             className="w-full text-sm border border-[#E8E2D6] rounded-lg p-2 text-[#5D4037] focus:border-[#C2A385] outline-none text-center"
                           />
                        </div>
                      </div>
                      <button onClick={handleSaveRoles} className="w-full py-2.5 text-xs font-bold text-white bg-[#8C7851] rounded-lg shadow-sm hover:bg-[#5D4037] transition-colors">儲存名稱設定</button>
                    </div>
                  </div>
               </div>
            </div>
          )}

          {/* Day View Modal */}
          {isDayViewModalOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-[#5D4037]/20 backdrop-blur-[2px] p-4">
               <div className="bg-white w-full max-w-sm rounded-[1.5rem] shadow-2xl overflow-hidden animate-in fade-in zoom-in-95 duration-200 border border-[#D2B48C]/30 flex flex-col max-h-[80vh]">
                  <div className="px-5 py-4 bg-[#FDFBF7] border-b border-[#F5F1E9] flex justify-between items-center shrink-0">
                     <div className="flex items-baseline gap-2">
                       <span className="text-2xl font-hand font-bold text-[#5D4037]">{viewingDate}</span>
                       <span className="text-xs text-[#8C7851] font-bold uppercase">{viewingDate && !isNaN(new Date(viewingDate).getTime()) ? new Date(viewingDate).toLocaleDateString('en-US', { weekday: 'long' }) : ''}</span>
                     </div>
                     <button onClick={() => setIsDayViewModalOpen(false)} className="p-1.5 text-[#D2B48C] hover:bg-[#F5F1E9] rounded-full transition-colors"><X className="w-5 h-5" /></button>
                  </div>
                  <div className="p-4 overflow-y-auto flex-1 space-y-3 bg-[#FDFBF7]">
                     {dayViewEvents.length === 0 ? (
                        <div className="flex flex-col items-center justify-center py-10 opacity-50 text-[#8C7851]">
                           <Coffee className="w-10 h-10 mb-2" /><p className="font-hand text-lg">今天沒有行程，享受生活吧！</p>
                        </div>
                     ) : (
                        dayViewEvents.map(ev => {
                           const style = COLORS[ev.color] || COLORS.latte;
                           // Identify owner label
                           let ownerLabel = '';
                           if (ev.eventType === 'me') ownerLabel = roleSettings.role1;
                           else if (ev.eventType === 'partner') ownerLabel = roleSettings.role2;
                           else ownerLabel = '共同';

                           return (
                             <div key={ev.id} onClick={() => openEditModal(null, ev)} className="bg-white p-3 rounded-xl border border-[#E8E2D6] shadow-sm flex items-center gap-3 cursor-pointer hover:shadow-md transition-shadow">
                                <div className={`w-3 h-3 rounded-full ${style.fill} shrink-0`}></div>
                                <div className="flex-1 min-w-0">
                                   <div className="flex justify-between items-start">
                                      <h4 className="font-bold text-[#5D4037] truncate">{ev.title}</h4>
                                      <span className="text-[10px] bg-[#F5F1E9] text-[#8C7851] px-1.5 py-0.5 rounded ml-2 whitespace-nowrap">{ownerLabel}</span>
                                   </div>
                                   <div className="flex items-center gap-2 text-xs text-[#8C7851]">{ev.isAllDay ? <span className="bg-[#E8E2D6] px-1.5 rounded text-[#5D4037]">全天</span> : <span className="font-hand text-sm">{ev.startTime} - {ev.endTime}</span>}</div>
                                </div>
                                <Edit className="w-4 h-4 text-[#D2B48C]" />
                             </div>
                           )
                        })
                     )}
                  </div>
                  <div className="p-4 border-t border-[#F5F1E9] bg-white shrink-0">
                     <button onClick={() => openEditModal(viewingDate)} className="w-full bg-[#C2A385] hover:bg-[#A68664] text-white py-3 rounded-xl shadow-md font-bold flex items-center justify-center gap-2 transition-colors"><Plus className="w-5 h-5" /> 新增行程</button>
                  </div>
               </div>
            </div>
          )}

          {/* Edit Modal */}
          {isEditModalOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-[#5D4037]/20 backdrop-blur-[2px] p-4">
              <div className="bg-white w-full max-w-sm rounded-[1.5rem] shadow-2xl overflow-hidden animate-in fade-in zoom-in-95 duration-200 border border-[#D2B48C]/30">
                <div className="px-5 py-4 bg-[#FDFBF7] border-b border-[#F5F1E9] flex justify-between items-center">
                   <h3 className="text-[#5D4037] font-bold flex items-center gap-2"><Leaf className="w-4 h-4 text-[#C2A385]" /> {editingId ? '編輯行程' : '建立行程'}</h3>
                   <div className="flex gap-2">
                     {editingId && <button onClick={deleteEvent} className="p-1.5 text-[#D2B48C] hover:text-red-500 hover:bg-red-50 rounded-full transition-colors"><Trash2 className="w-4 h-4" /></button>}
                     <button onClick={() => setIsEditModalOpen(false)} className="p-1.5 text-[#D2B48C] hover:bg-[#F5F1E9] rounded-full transition-colors"><X className="w-4 h-4" /></button>
                   </div>
                </div>
                <div className="p-6 space-y-5">
                  <div className="flex gap-2 p-1 bg-[#F5F1E9] rounded-xl">
                     {['me', 'partner', 'common'].map(type => (
                        <button key={type} onClick={() => { setFormEventType(type); if(type === 'me') setFormColor('tea'); if(type === 'partner') setFormColor('sesame'); if(type === 'common') setFormColor('latte'); }} className={`flex-1 py-1.5 text-xs font-bold rounded-lg transition-all ${formEventType === type ? 'bg-white shadow text-[#5D4037]' : 'text-[#8C7851] opacity-60'}`}>
                          {type === 'me' ? roleSettings.role1 : type === 'partner' ? roleSettings.role2 : '共同'}
                        </button>
                     ))}
                  </div>
                  <input type="text" value={formTitle} onChange={(e) => setFormTitle(e.target.value)} placeholder="行程標題..." className="w-full text-xl font-bold text-[#5D4037] placeholder-[#D2B48C] outline-none border-b-2 border-[#F5F1E9] focus:border-[#C2A385] bg-transparent py-1 transition-colors" autoFocus />
                  <div className="space-y-3 bg-[#FDFBF7] p-3 rounded-xl border border-[#F5F1E9]">
                     <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2 text-[#5D4037] font-bold text-sm"><Clock className="w-4 h-4 text-[#C2A385]" /> 時間</div>
                        <label className="flex items-center gap-2 text-xs font-bold text-[#8C7851] cursor-pointer"><input type="checkbox" checked={formIsAllDay} onChange={e => setFormIsAllDay(e.target.checked)} className="accent-[#C2A385]" /> 全天</label>
                     </div>
                     <div className="grid grid-cols-[auto_1fr] gap-2 items-center text-sm">
                        <span className="text-[#8C7851] text-xs font-bold">開始</span>
                        <div className="flex gap-2">
                           <input type="date" value={formStartDate} onChange={e => setFormStartDate(e.target.value)} className="bg-white border border-[#E8E2D6] rounded px-2 py-1 text-[#5D4037] w-full font-hand text-lg" />
                           {!formIsAllDay && <input type="time" value={formStartTime} onChange={e => setFormStartTime(e.target.value)} className="bg-white border border-[#E8E2D6] rounded px-1 py-1 text-[#5D4037] font-hand text-lg" />}
                        </div>
                        <span className="text-[#8C7851] text-xs font-bold">結束</span>
                        <div className="flex gap-2">
                           <input type="date" value={formEndDate} onChange={e => setFormEndDate(e.target.value)} className="bg-white border border-[#E8E2D6] rounded px-2 py-1 text-[#5D4037] w-full font-hand text-lg" />
                           {!formIsAllDay && <input type="time" value={formEndTime} onChange={e => setFormEndTime(e.target.value)} className="bg-white border border-[#E8E2D6] rounded px-1 py-1 text-[#5D4037] font-hand text-lg" />}
                        </div>
                     </div>
                  </div>
                  <div className="flex gap-3">
                     <AlignLeft className="w-4 h-4 text-[#C2A385] mt-1 shrink-0" />
                     <textarea placeholder="備註說明..." value={formDesc} onChange={e => setFormDesc(e.target.value)} className="w-full bg-[#FDFBF7] rounded-xl p-3 text-sm text-[#5D4037] h-20 outline-none border border-[#F5F1E9] focus:border-[#C2A385] resize-none" />
                  </div>
                  <div className="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
                    {Object.entries(COLORS).map(([key, style]) => (
                      <button key={key} onClick={() => setFormColor(key)} className={`w-8 h-8 rounded-full shrink-0 transition-transform flex items-center justify-center ${style.fill} ${formColor === key ? 'ring-2 ring-offset-2 ring-[#8C7851] scale-110' : 'hover:scale-105 opacity-80 hover:opacity-100'}`}>
                        {formColor === key && <CheckSquare className="w-4 h-4 text-white drop-shadow-md" />}
                      </button>
                    ))}
                  </div>
                </div>
                <div className="px-5 py-4 border-t border-[#F5F1E9] bg-[#FDFBF7] flex justify-end">
                  <button onClick={saveEvent} className="bg-[#C2A385] hover:bg-[#A68664] text-white text-sm font-bold py-2.5 px-6 rounded-xl shadow-md transition-colors flex items-center gap-2"><Save className="w-4 h-4" /> 儲存行程</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
