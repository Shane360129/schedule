import React, { useState, useEffect, useMemo } from 'react';
import { 
  ChevronLeft, ChevronRight, X, Sparkles, Clock, Trash2, 
  Loader2, Save, Coffee, AlignLeft, Leaf, CheckSquare, Settings
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  onAuthStateChanged, 
  signInAnonymously, 
  signInWithCustomToken,
  User
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  query, 
  onSnapshot, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  doc 
} from 'firebase/firestore';

// --- Firebase Configuration ---
// 已更新為您的專案設定
const firebaseConfig = {
  apiKey: "AIzaSyAaeMl8u3S8Atf5b9Z4MvYRfxNWqyxjvck",
  authDomain: "schdule-f5cda.firebaseapp.com",
  projectId: "schdule-f5cda",
  storageBucket: "schdule-f5cda.firebasestorage.app",
  messagingSenderId: "318490887020",
  appId: "1:318490887020:web:115d4b35f544455768e949",
  measurementId: "G-Q7ZEKV7YEH"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
// 為了確保資料路徑正確，若沒有外部注入 appId，我們使用您的 projectId 作為預設路徑的一部分
const appId = typeof __app_id !== 'undefined' ? __app_id : 'schdule-f5cda';

// --- BiBi Style Constants ---
const COLORS = {
  milk: { name: '燕麥奶', bg: 'bg-[#FDFBF7]', text: 'text-[#8C7851]', border: 'border-[#E8E2D6]', fill: 'bg-[#E8E2D6]', hex: '#E8E2D6' },
  tea: { name: '伯爵茶', bg: 'bg-[#F5F1E9]', text: 'text-[#5D4037]', border: 'border-[#D2B48C]', fill: 'bg-[#D2B48C]', hex: '#D2B48C' }, 
  latte: { name: '深焙', bg: 'bg-[#C2A385]', text: 'text-white', border: 'border-[#8B4513]', fill: 'bg-[#C2A385]', hex: '#C2A385' }, 
  matcha: { name: '抹茶', bg: 'bg-[#F0FDF4]', text: 'text-[#166534]', border: 'border-[#BBF7D0]', fill: 'bg-[#86EFAC]', hex: '#86EFAC' }, 
  berry: { name: '莓果', bg: 'bg-[#FFF1F2]', text: 'text-[#9F1239]', border: 'border-[#FECDD3]', fill: 'bg-[#FDA4AF]', hex: '#FDA4AF' },
  taro: { name: '芋泥', bg: 'bg-[#FAF5FF]', text: 'text-[#6B21A8]', border: 'border-[#E9D5FF]', fill: 'bg-[#D8B4FE]', hex: '#D8B4FE' },
  lemon: { name: '檸檬塔', bg: 'bg-[#FEFCE8]', text: 'text-[#854D0E]', border: 'border-[#FEF08A]', fill: 'bg-[#FDE047]', hex: '#FDE047' },
  sesame: { name: '芝麻', bg: 'bg-[#F8FAFC]', text: 'text-[#334155]', border: 'border-[#CBD5E1]', fill: 'bg-[#94A3B8]', hex: '#94A3B8' },
  earl: { name: '伯爵藍', bg: 'bg-[#F0F9FF]', text: 'text-[#0C4A6E]', border: 'border-[#BAE6FD]', fill: 'bg-[#7DD3FC]', hex: '#7DD3FC' },
};

const HOURS = Array.from({ length: 24 }, (_, i) => String(i).padStart(2, '0'));
const MINUTES = ['00', '10', '20', '30', '40', '50'];

// --- Type Definitions ---
type EventType = {
  id: string;
  title: string;
  description?: string;
  startDate: string; // YYYY-MM-DD
  endDate: string;   // YYYY-MM-DD
  startTime?: string;
  endTime?: string;
  isAllDay: boolean;
  color: keyof typeof COLORS;
  eventType: 'me' | 'partner' | 'common';
};

// --- Helper Functions ---
const getDaysInMonth = (year: number, month: number) => new Date(year, month + 1, 0).getDate();
const getFirstDayOfMonth = (year: number, month: number) => new Date(year, month, 1).getDay(); // 0 = Sunday

const formatDate = (date: Date) => {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
};

const App = () => {
  // --- State ---
  const [user, setUser] = useState<User | null>(null);
  const [currentDate, setCurrentDate] = useState(new Date());
  const [events, setEvents] = useState<EventType[]>([]);
  const [loading, setLoading] = useState(true);
  const [holidayData, setHolidayData] = useState<any>({});
  
  // Profiles (Local State for UI)
  const [myProfile] = useState({ name: '我', color: 'tea' });
  const [partnerProfile] = useState({ name: '夥伴', color: 'sesame' });

  // UI State
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  
  // Form State
  const [formTitle, setFormTitle] = useState('');
  const [formDesc, setFormDesc] = useState('');
  const [formStartDate, setFormStartDate] = useState('');
  const [formEndDate, setFormEndDate] = useState('');
  const [formIsAllDay, setFormIsAllDay] = useState(true);
  const [formStartTime, setFormStartTime] = useState('09:00');
  const [formEndTime, setFormEndTime] = useState('10:00');
  const [formColor, setFormColor] = useState<keyof typeof COLORS>('latte');
  const [formEventType, setFormEventType] = useState<'me' | 'partner' | 'common'>('common');

  // --- Auth & Data ---
  useEffect(() => {
    const initAuth = async () => {
      // 優先嘗試使用 Canvas 環境提供的 Token，若無則匿名登入
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        try {
          await signInWithCustomToken(auth, __initial_auth_token);
        } catch (e) {
          console.warn("Custom token failed, falling back to anonymous", e);
          await signInAnonymously(auth);
        }
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // Fetch Holidays
  useEffect(() => {
    const fetchHolidays = async () => {
      const year = currentDate.getFullYear();
      try {
        const response = await fetch(`https://cdn.jsdelivr.net/gh/ruyut/TaiwanCalendar/data/${year}.json`);
        if (!response.ok) return;
        const rawData = await response.json();
        const formatted = rawData.reduce((acc: any, curr: any) => {
          const dStr = curr.date; // YYYYMMDD
          const ymd = `${dStr.substring(0, 4)}-${dStr.substring(4, 6)}-${dStr.substring(6, 8)}`;
          acc[ymd] = { isHoliday: curr.isHoliday, name: curr.description };
          return acc;
        }, {});
        setHolidayData((prev: any) => ({ ...prev, [year]: formatted }));
      } catch (err) { console.error(err); }
    };
    fetchHolidays();
  }, [currentDate.getFullYear()]);

  // Firestore Listener
  useEffect(() => {
    if (!user) return;
    
    // Path: artifacts/{appId}/users/{userId}/bibi_events
    const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'bibi_events'));
    
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const loadedEvents: EventType[] = [];
      snapshot.forEach((doc) => {
        loadedEvents.push({ id: doc.id, ...doc.data() } as EventType);
      });
      setEvents(loadedEvents);
      setLoading(false);
    }, (error) => {
      console.error("Firestore Error:", error);
      setLoading(false);
    });
    return () => unsubscribe();
  }, [user]);

  // --- Calendar Logic ---
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const daysInMonth = getDaysInMonth(year, month);
  const firstDay = getFirstDayOfMonth(year, month);
  
  const days = [];
  // 1. Prev Month Padding
  for (let i = firstDay - 1; i >= 0; i--) {
    days.push({ day: null, fullDate: '' }); 
  }
  // 2. Current Month
  for (let i = 1; i <= daysInMonth; i++) {
    const dStr = String(i).padStart(2, '0');
    const mStr = String(month + 1).padStart(2, '0');
    days.push({ day: i, fullDate: `${year}-${mStr}-${dStr}` });
  }
  // 3. Next Month Padding (Force 42 cells)
  const remainingCells = 42 - days.length;
  for (let i = 1; i <= remainingCells; i++) {
    days.push({ day: null, fullDate: '' });
  }

  // --- Handlers ---
  const handlePrevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
  const handleNextMonth = () => setCurrentDate(new Date(year, month + 1, 1));
  const handleToday = () => setCurrentDate(new Date());

  const resetForm = (dateStr: string) => {
    setEditingId(null);
    setFormTitle('');
    setFormDesc('');
    setFormStartDate(dateStr);
    setFormEndDate(dateStr);
    setFormIsAllDay(true);
    setFormStartTime('09:00');
    setFormEndTime('10:00');
    setFormColor('latte');
    setFormEventType('common');
  };

  const handleCellClick = (dateStr: string) => {
    if (!dateStr) return;
    resetForm(dateStr);
    setIsModalOpen(true);
  };

  const handleEventClick = (e: React.MouseEvent, event: EventType) => {
    e.stopPropagation();
    setEditingId(event.id);
    setFormTitle(event.title);
    setFormDesc(event.description || '');
    setFormStartDate(event.startDate);
    setFormEndDate(event.endDate);
    setFormIsAllDay(event.isAllDay);
    setFormStartTime(event.startTime || '09:00');
    setFormEndTime(event.endTime || '10:00');
    setFormColor(event.color);
    setFormEventType(event.eventType);
    setIsModalOpen(true);
  };

  const saveEvent = async () => {
    if (!user || !formTitle || !formStartDate || !formEndDate) return;
    
    let start = formStartDate;
    let end = formEndDate;
    if (new Date(start) > new Date(end)) [start, end] = [end, start];

    const eventData = {
      title: formTitle,
      description: formDesc,
      startDate: start,
      endDate: end,
      isAllDay: formIsAllDay,
      startTime: formStartTime,
      endTime: formEndTime,
      color: formColor,
      eventType: formEventType
    };

    try {
      if (editingId) {
        await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'bibi_events', editingId), eventData);
      } else {
        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'bibi_events'), eventData);
      }
      setIsModalOpen(false);
    } catch (e) { console.error("Save Error:", e); }
  };

  const deleteEvent = async () => {
    if (user && editingId) {
      try {
        await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'bibi_events', editingId));
        setIsModalOpen(false);
      } catch (e) { console.error("Delete Error:", e); }
    }
  };

  // --- Multi-day Rendering Engine ---
  const getEventSegments = (dateStr: string) => {
    if (!dateStr) return [];
    
    const dayEvents = events.filter(ev => dateStr >= ev.startDate && dateStr <= ev.endDate);
    
    // Sort logic: All-day/Longer events first
    dayEvents.sort((a, b) => {
      const lenA = new Date(a.endDate).getTime() - new Date(a.startDate).getTime();
      const lenB = new Date(b.endDate).getTime() - new Date(b.startDate).getTime();
      if (lenA !== lenB) return lenB - lenA; // Longer first
      return (a.startTime || '00:00').localeCompare(b.startTime || '00:00');
    });

    return dayEvents.map(ev => {
      const isStart = dateStr === ev.startDate;
      const isEnd = dateStr === ev.endDate;
      const dayOfWeek = new Date(dateStr).getDay();
      
      return { ...ev, isStart, isEnd, isSunday: dayOfWeek === 0, isSaturday: dayOfWeek === 6 };
    });
  };

  if (loading) {
    return (
      <div className="h-dvh flex items-center justify-center bg-[#F5F1E9]">
        <div className="flex flex-col items-center gap-2">
           <Loader2 className="w-8 h-8 text-[#C2A385] animate-spin" />
           <span className="text-[#8C7851] font-serif text-sm">Loading BiBi...</span>
        </div>
      </div>
    );
  }

  return (
    <div className="h-dvh flex flex-col bg-[#F5F1E9] text-[#5D4037] font-serif overflow-hidden">
      
      {/* Header */}
      <header className="flex-none flex items-center justify-between px-4 py-3 bg-[#F5F1E9] border-b border-[#D2B48C]/20 z-10">
        <div className="flex items-center gap-3">
           <div className="bg-white p-2 rounded-xl shadow-sm border border-[#E8E2D6]">
             <Sparkles className="w-5 h-5 text-[#C2A385]" />
           </div>
           <div>
             <h1 className="text-xl font-bold tracking-tight text-[#5D4037]">BiBi-Schedule</h1>
             <p className="text-[10px] text-[#8C7851] uppercase tracking-widest hidden sm:block">
               {year} . {month + 1}
             </p>
           </div>
        </div>
        
        <div className="flex items-center gap-3 bg-white/50 p-1.5 rounded-2xl border border-[#D2B48C]/10 backdrop-blur-sm">
          <button onClick={handlePrevMonth} className="p-2 hover:bg-[#E8E2D6]/50 rounded-xl transition-colors text-[#8C7851]">
            <ChevronLeft className="w-5 h-5" />
          </button>
          <span className="text-lg font-bold min-w-[100px] text-center text-[#5D4037]">
            {month + 1}月 <span className="text-sm font-normal text-[#8C7851]">{year}</span>
          </span>
          <button onClick={handleNextMonth} className="p-2 hover:bg-[#E8E2D6]/50 rounded-xl transition-colors text-[#8C7851]">
            <ChevronRight className="w-5 h-5" />
          </button>
        </div>
        
        <button onClick={handleToday} className="bg-[#C2A385] text-white px-3 py-1.5 text-xs font-bold rounded-lg shadow-sm hover:bg-[#A68664] transition-colors">
          今天
        </button>
      </header>

      {/* Weekday Header */}
      <div className="flex-none grid grid-cols-7 border-b border-[#D2B48C]/20 bg-[#FDFBF7]">
        {['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'].map((d, i) => (
          <div key={i} className="py-2 text-center text-[10px] font-bold tracking-widest text-[#D2B48C]">
            {d}
          </div>
        ))}
      </div>

      {/* Main Grid */}
      <div className="flex-1 grid grid-cols-7 grid-rows-6 w-full h-full">
        {days.map((cell, idx) => {
            const hasDate = cell.day !== null;
            const segments = hasDate ? getEventSegments(cell.fullDate) : [];
            const isToday = hasDate && cell.fullDate === formatDate(new Date());
            const holidayInfo = hasDate ? holidayData[year]?.[cell.fullDate.replace(/-/g,'')] : null;
            const isHoliday = holidayInfo?.isHoliday;

            return (
            <div 
              key={idx}
              onClick={() => hasDate && handleCellClick(cell.fullDate)}
              className={`
                relative border-b border-r border-[#D2B48C]/10 flex flex-col
                ${!hasDate ? 'bg-[#F5F1E9]/50' : 'bg-[#FDFBF7]'}
                active:bg-[#F5F1E9] transition-colors cursor-pointer select-none
                overflow-hidden
              `}
            >
              {/* Date Number & Holiday */}
              {hasDate && (
                <div className="flex flex-col items-center pt-1 mb-0.5">
                   <span className={`
                      text-sm sm:text-base font-bold h-7 w-7 flex items-center justify-center rounded-full transition-all
                      ${isToday ? 'bg-[#C2A385] text-white shadow-md' : 'text-[#5D4037]'}
                      ${isHoliday ? 'text-[#C2A385]' : ''}
                   `}>
                     {cell.day}
                   </span>
                   {isHoliday && (
                     <span className="text-[9px] text-[#C2A385] font-medium -mt-1 truncate max-w-full px-1">
                       {holidayInfo.name}
                     </span>
                   )}
                </div>
              )}

              {/* Events Container - BiBi Style Bars */}
              <div className="flex-1 flex flex-col gap-[2px] w-full px-0.5 pb-1">
                {segments.slice(0, 4).map((ev) => {
                  const roundLeft = ev.isStart || ev.isSunday;
                  const roundRight = ev.isEnd || ev.isSaturday;
                  const style = COLORS[ev.color] || COLORS.latte;
                  
                  return (
                    <div 
                      key={ev.id}
                      onClick={(e) => handleEventClick(e, ev)}
                      className={`
                        text-[10px] sm:text-xs h-[18px] sm:h-[20px]
                        flex items-center px-1 shadow-sm transition-all hover:brightness-95
                        ${style.fill} ${style.text === 'text-white' ? 'text-white' : 'text-[#5D4037]'}
                        ${roundLeft ? 'rounded-l-md ml-0.5' : '-ml-[1px]'} 
                        ${roundRight ? 'rounded-r-md mr-0.5' : '-mr-[1px]'}
                        ${!roundLeft && !roundRight ? 'z-0' : 'z-10 relative'}
                      `}
                    >
                      {(ev.isStart || ev.isSunday) && (
                        <span className="truncate w-full font-medium leading-none flex items-center gap-1">
                          {!ev.isAllDay && ev.startTime && <span className="text-[9px] opacity-80">{ev.startTime}</span>}
                          {ev.title}
                        </span>
                      )}
                    </div>
                  );
                })}
                {segments.length > 4 && (
                   <div className="text-[9px] text-[#D2B48C] text-center leading-none mt-auto font-bold">
                     +{segments.length - 4}
                   </div>
                )}
              </div>
            </div>
          )
        })}
      </div>

      {/* Add/Edit Modal - BiBi Style */}
      {isModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-[#5D4037]/20 backdrop-blur-[2px] p-4">
          <div className="bg-white w-full max-w-sm rounded-[1.5rem] shadow-2xl overflow-hidden animate-in fade-in zoom-in-95 duration-200 border border-[#D2B48C]/30">
            
            <div className="px-5 py-4 bg-[#FDFBF7] border-b border-[#F5F1E9] flex justify-between items-center">
               <h3 className="text-[#5D4037] font-bold flex items-center gap-2">
                 <Leaf className="w-4 h-4 text-[#C2A385]" />
                 {editingId ? '編輯行程' : '建立行程'}
               </h3>
               <div className="flex gap-2">
                 {editingId && (
                    <button onClick={deleteEvent} className="p-1.5 text-[#D2B48C] hover:text-red-500 hover:bg-red-50 rounded-full transition-colors">
                      <Trash2 className="w-4 h-4" />
                    </button>
                 )}
                 <button onClick={() => setIsModalOpen(false)} className="p-1.5 text-[#D2B48C] hover:bg-[#F5F1E9] rounded-full transition-colors">
                   <X className="w-4 h-4" />
                 </button>
               </div>
            </div>

            <div className="p-6 space-y-5">
              
              {/* Profile/Type Toggle */}
              <div className="flex gap-2 p-1 bg-[#F5F1E9] rounded-xl">
                 {(['me', 'partner', 'common'] as const).map(type => {
                    const isActive = formEventType === type;
                    const label = type === 'me' ? myProfile.name : type === 'partner' ? partnerProfile.name : '共同';
                    return (
                      <button 
                        key={type}
                        onClick={() => {
                          setFormEventType(type);
                          // Auto set color based on type preference
                          if(type === 'me') setFormColor('tea'); 
                          if(type === 'partner') setFormColor('sesame'); 
                          if(type === 'common') setFormColor('latte');
                        }}
                        className={`flex-1 py-1.5 text-xs font-bold rounded-lg transition-all ${isActive ? 'bg-white shadow text-[#5D4037]' : 'text-[#8C7851] opacity-60'}`}
                      >
                        {label}
                      </button>
                    )
                 })}
              </div>

              {/* Title */}
              <input 
                type="text" 
                value={formTitle}
                onChange={(e) => setFormTitle(e.target.value)}
                placeholder="行程標題..."
                className="w-full text-xl font-bold text-[#5D4037] placeholder-[#D2B48C] outline-none border-b-2 border-[#F5F1E9] focus:border-[#C2A385] bg-transparent py-1 transition-colors"
                autoFocus
              />

              {/* Time Section */}
              <div className="space-y-3 bg-[#FDFBF7] p-3 rounded-xl border border-[#F5F1E9]">
                 <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2 text-[#5D4037] font-bold text-sm">
                      <Clock className="w-4 h-4 text-[#C2A385]" /> 時間
                    </div>
                    <label className="flex items-center gap-2 text-xs font-bold text-[#8C7851] cursor-pointer">
                      <input type="checkbox" checked={formIsAllDay} onChange={e => setFormIsAllDay(e.target.checked)} className="accent-[#C2A385]" />
                      全天
                    </label>
                 </div>
                 
                 <div className="grid grid-cols-[auto_1fr] gap-2 items-center text-sm">
                    <span className="text-[#8C7851] text-xs font-bold">開始</span>
                    <div className="flex gap-2">
                       <input type="date" value={formStartDate} onChange={e => setFormStartDate(e.target.value)} className="bg-white border border-[#E8E2D6] rounded px-2 py-1 text-[#5D4037] w-full" />
                       {!formIsAllDay && <input type="time" value={formStartTime} onChange={e => setFormStartTime(e.target.value)} className="bg-white border border-[#E8E2D6] rounded px-1 py-1 text-[#5D4037]" />}
                    </div>
                    
                    <span className="text-[#8C7851] text-xs font-bold">結束</span>
                    <div className="flex gap-2">
                       <input type="date" value={formEndDate} onChange={e => setFormEndDate(e.target.value)} className="bg-white border border-[#E8E2D6] rounded px-2 py-1 text-[#5D4037] w-full" />
                       {!formIsAllDay && <input type="time" value={formEndTime} onChange={e => setFormEndTime(e.target.value)} className="bg-white border border-[#E8E2D6] rounded px-1 py-1 text-[#5D4037]" />}
                    </div>
                 </div>
              </div>

              {/* Description */}
              <div className="flex gap-3">
                 <AlignLeft className="w-4 h-4 text-[#C2A385] mt-1 shrink-0" />
                 <textarea 
                   placeholder="備註說明..." 
                   value={formDesc}
                   onChange={e => setFormDesc(e.target.value)}
                   className="w-full bg-[#FDFBF7] rounded-xl p-3 text-sm text-[#5D4037] h-20 outline-none border border-[#F5F1E9] focus:border-[#C2A385] resize-none"
                 />
              </div>

              {/* Colors */}
              <div className="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
                {Object.entries(COLORS).map(([key, style]) => (
                  <button
                    key={key}
                    onClick={() => setFormColor(key as any)}
                    title={style.name}
                    className={`
                       w-8 h-8 rounded-full shrink-0 transition-transform flex items-center justify-center
                       ${style.fill} 
                       ${formColor === key ? 'ring-2 ring-offset-2 ring-[#8C7851] scale-110' : 'hover:scale-105 opacity-80 hover:opacity-100'}
                    `}
                  >
                    {formColor === key && <CheckSquare className="w-4 h-4 text-white drop-shadow-md" />}
                  </button>
                ))}
              </div>

            </div>

            {/* Modal Footer */}
            <div className="px-5 py-4 border-t border-[#F5F1E9] bg-[#FDFBF7] flex justify-end">
              <button 
                onClick={saveEvent}
                className="bg-[#C2A385] hover:bg-[#A68664] text-white text-sm font-bold py-2.5 px-6 rounded-xl shadow-md transition-colors flex items-center gap-2"
              >
                <Save className="w-4 h-4" />
                儲存行程
              </button>
            </div>

          </div>
        </div>
      )}
    </div>
  );
};

export default App;
